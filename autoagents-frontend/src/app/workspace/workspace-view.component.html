<section class="workspace">
  <header class="workspace__header">
    <div class="workspace__title">
      <h1>Project Workspace</h1>
      <p class="workspace__subtitle">
        Stay on top of project health, feature approvals, and story progress.
      </p>
    </div>
    <div class="workspace__actions">
      <button type="button" class="workspace__action workspace__action--ghost" (click)="onExit()">
        Open chat
      </button>
    </div>
  </header>

  <section class="workspace__project-hero" *ngIf="project as activeProject">
    <div>
      <h2>{{ activeProject.details.name }}</h2>
      <p>{{ activeProject.details.description || 'Project description will appear here.' }}</p>
      <div class="project-hero__meta">
        <span class="project-pill">
          <strong>Key</strong>
          {{ activeProject.details.key || '—' }}
        </span>
        <span class="project-pill">
          <strong>Industry</strong>
          {{ activeProject.details.industry }}
        </span>
        <span class="project-pill">
          <strong>Methodology</strong>
          {{ activeProject.details.methodology | titlecase }}
        </span>
        <span class="project-pill">
          <strong>Team Size</strong>
          {{ activeProject.details.teamSize || 'TBD' }}
        </span>
      </div>
    </div>
    <div class="project-hero__ai" *ngIf="activeProject.aiSummary as summary">
      <h3>Executive Summary</h3>
      <p>{{ summary.executiveSummary }}</p>
      <div *ngIf="summary.epicIdeas?.length">
        <h4>Epic Ideas</h4>
        <ul>
          <li *ngFor="let epic of summary.epicIdeas">{{ epic }}</li>
        </ul>
      </div>
      <div *ngIf="summary.riskNotes?.length">
        <h4>Risks</h4>
        <ul>
          <li *ngFor="let risk of summary.riskNotes">{{ risk }}</li>
        </ul>
      </div>
    </div>
  </section>

  <ng-container *ngIf="project || features.length || stories.length; else emptyWorkspace">
    <section class="workspace__dashboard">
      <section class="workspace__cta" *ngIf="!project">
        <h2>Start a new project</h2>
        <p>Kick off a fresh workspace to capture features, stories, and visualizations.</p>
        <button type="button" class="workspace__action workspace__action--primary" (click)="onCreateProject()">
          New Project
        </button>
      </section>

      <div class="dashboard__grid">
        <article class="dashboard-card">
          <header>
            <h3>Project Metrics</h3>
          </header>
          <div class="dashboard-metrics">
            <div>
              <span class="metric-value">{{ features.length }}</span>
              <span class="metric-label">Features</span>
            </div>
            <div>
              <span class="metric-value">{{ stories.length }}</span>
              <span class="metric-label">Stories</span>
            </div>
            <div>
              <span class="metric-value">{{ mermaidInput.split('\n').length }}</span>
              <span class="metric-label">Diagram Lines</span>
            </div>
          </div>
        </article>
        <article class="dashboard-card" *ngIf="prompt">
          <header>
            <h3>Prompt Overview</h3>
          </header>
          <p>{{ prompt }}</p>
        </article>
        <ng-container *ngIf="visualizationData?.callouts as callouts">
          <article class="dashboard-card" *ngIf="callouts.length">
            <header>
              <h3>Agent Callouts</h3>
            </header>
            <ul>
              <li *ngFor="let callout of callouts">{{ callout }}</li>
            </ul>
          </article>
        </ng-container>
      </div>

      <div class="dashboard__columns">
        <section class="dashboard-panel">
          <header>
            <h2>Latest Stories</h2>
          </header>
          <p *ngIf="!stories.length" class="empty-hint">Approve stories to populate the dashboard.</p>
          <div class="dashboard-scroll" *ngIf="stories.length">
            <article class="story-chip" *ngFor="let story of stories; let storyIndex = index">
              <header>
                <h3>{{ story.featureTitle }}</h3>
                <p>{{ story.userStory }}</p>
              </header>

              <div *ngIf="story.acceptanceCriteria?.length">
                <h4>Acceptance Criteria</h4>
                <ul>
                  <li *ngFor="let criterion of story.acceptanceCriteria">{{ criterion }}</li>
                </ul>
              </div>

              <div *ngIf="story.implementationNotes?.length">
                <h4>Implementation Notes</h4>
                <ol>
                  <li *ngFor="let note of story.implementationNotes">{{ note }}</li>
                </ol>
              </div>

              <feedback-chatbot
                [itemId]="'story-' + storyIndex"
                itemType="story"
                [projectId]="projectId || ''"
                [originalContent]="story"
                [projectContext]="prompt"
                (contentRegenerated)="onStoryRegenerated($event, storyIndex)"
                (errorOccurred)="onFeedbackError($event)"
              ></feedback-chatbot>
            </article>
          </div>
        </section>
      </div>

      <section class="workspace__studio">
        <div class="studio-grid">
          <article class="studio-panel studio-panel--editor">
            <header class="studio-panel__header">
              <div>
                <h2>Mermaid Diagram</h2>
                <p>Edit the Mermaid definition. Changes render instantly.</p>
              </div>
              <div class="studio-panel__controls">
                <div class="diagram-type-dropdown" role="group" aria-label="Diagram type selector">
                  <button
                    type="button"
                    class="workspace__action workspace__action--outline diagram-type-dropdown__button"
                    (click)="toggleDiagramDropdown()"
                    [attr.aria-expanded]="isDiagramDropdownOpen"
                    [attr.aria-haspopup]="true"
                  >
                    <span>Diagram Type: {{ getCurrentDiagramTypeLabel() }}</span>
                    <span class="dropdown-arrow" [class.dropdown-arrow--open]="isDiagramDropdownOpen">▼</span>
                  </button>
                  <div class="diagram-type-dropdown__menu" *ngIf="isDiagramDropdownOpen" (click)="$event.stopPropagation()">
                    <button
                      *ngFor="let dt of diagramTypes"
                      type="button"
                      class="diagram-type-dropdown__item"
                      [class.diagram-type-dropdown__item--active]="isDiagramTypeActive(dt.value)"
                      [title]="dt.description"
                      (click)="onDiagramTypeChange(dt.value)"
                    >
                      <span class="diagram-type-label">{{ dt.label }}</span>
                      <span class="diagram-type-full-label">{{ dt.fullLabel }}</span>
                      <span class="diagram-type-check" *ngIf="isDiagramTypeActive(dt.value)">✓</span>
                    </button>
                  </div>
                </div>
                <div class="studio-panel__controls-divider"></div>
                <input
                  type="file"
                  accept=".mermaid,.mmd,text/mermaid,text/plain"
                  #mermaidFileInput
                  (change)="onMermaidFileSelected($event)"
                  hidden
                />
                <button
                  type="button"
                  class="workspace__action workspace__action--ghost"
                  (click)="renderMermaid()"
                  [disabled]="mermaidSaving"
                >
                  Run
                </button>
                <button type="button" class="workspace__action workspace__action--outline" (click)="onMermaidUploadClick()">
                  Import Mermaid
                </button>
                <button type="button" class="workspace__action workspace__action--outline" (click)="onMermaidCopy()">
                  {{ isMermaidCopied ? 'Copied!' : 'Copy' }}
                </button>
                <button
                  type="button"
                  class="workspace__action workspace__action--primary"
                  (click)="onMermaidSave()"
                  [disabled]="mermaidSaving"
                >
                  {{ mermaidSaving ? 'Saving…' : 'Save' }}
                </button>
              </div>
            </header>

            <div class="studio-panel__body">
              <div class="studio-panel__editor">
                <pre class="studio-panel__line-numbers" [style.transform]="'translateY(' + (-lineNumberOffset) + 'px)'">
                  <span *ngFor="let line of mermaidLineNumbers">{{ line }}</span>
                </pre>
                <textarea
                  class="studio-panel__textarea"
                  [ngModel]="mermaidInput"
                  (ngModelChange)="onMermaidInput($event)"
                  (scroll)="onMermaidScroll($event)"
                  spellcheck="false"
                  placeholder="graph TD&#10;  prompt[&quot;Prompt&quot;] --> feature[&quot;Feature&quot;]"
                ></textarea>
              </div>
              <p *ngIf="mermaidError" class="studio-panel__error">{{ mermaidError }}</p>
            </div>

            <footer class="studio-panel__footer">
              <span>{{ mermaidInput.split('\n').length }} lines</span>
              <span>{{ mermaidInput.length }} characters</span>
              <span class="studio-badge studio-badge--ghost" *ngIf="isMermaidCopied">Copied to clipboard</span>
            </footer>
          </article>

          <article class="studio-panel studio-panel--preview">
            <header class="studio-panel__header">
              <div>
                <h2>Live Preview</h2>
                <p>The diagram reflects edits in real time.</p>
              </div>
              <div class="studio-panel__controls">
                <div class="preview-zoom" role="group" aria-label="Diagram zoom controls" *ngIf="showZoomControls">
                  <button
                    type="button"
                    class="preview-zoom__button"
                    (click)="zoomOut()"
                    [disabled]="!canZoomOut()"
                    aria-label="Zoom out"
                  >
                    -
                  </button>
                  <span class="preview-zoom__label">{{ (previewDisplayScale * 100) | number: '1.0-0' }}%</span>
                  <button
                    type="button"
                    class="preview-zoom__button"
                    (click)="zoomIn()"
                    [disabled]="!canZoomIn()"
                    aria-label="Zoom in"
                  >
                    +
                  </button>
                  <button
                    type="button"
                    class="preview-zoom__reset workspace__action workspace__action--ghost"
                    (click)="resetZoom()"
                    [disabled]="previewScale === 1"
                  >
                    Reset
                  </button>
                  <button
                    type="button"
                    class="preview-zoom__reset workspace__action workspace__action--ghost"
                    (click)="togglePreviewFit()"
                  >
                    {{ previewFitToContainer ? 'Actual Size' : 'Fit to View' }}
                  </button>
                </div>
                <span class="studio-badge">Theme: {{ previewTheme }}</span>
                <button type="button" class="workspace__action workspace__action--outline" (click)="togglePreviewTheme()">
                  Switch to {{ previewTheme === 'dark' ? 'light' : 'dark' }} mode
                </button>
                <div class="studio-panel__controls-divider"></div>
                <button
                  type="button"
                  class="workspace__action workspace__action--primary"
                  (click)="onRegenerateDiagram()"
                  title="Regenerate diagram with Agent 3"
                >
                  Regenerate Diagram
                </button>
              </div>
            </header>

            <div class="studio-panel__preview" [class.light]="previewTheme === 'light'">
              <div class="preview-scroll w-full h-full overflow-auto">
                <div class="preview-canvas" [class.preview-canvas--fit]="previewFitToContainer" #mermaidContainer></div>
              </div>
              <p *ngIf="shouldShowNoDiagramMessage()" class="preview-placeholder">
                No diagram available.
              </p>
            </div>

            <feedback-chatbot
              *ngIf="visualizationData"
              [itemId]="'visualization-' + currentDiagramType"
              itemType="visualization"
              [projectId]="projectId || ''"
              [originalContent]="{
                mermaid: mermaidInput,
                diagramType: currentDiagramType,
                features: features,
                stories: stories,
                prompt: prompt,
                projectTitle: project?.details?.name || 'Project'
              }"
              [projectContext]="prompt"
              (contentRegenerated)="onVisualizationRegenerated($event)"
              (errorOccurred)="onFeedbackError($event)"
            ></feedback-chatbot>

            <div class="studio-panel__insights" *ngIf="visualizationData as viz">
              <section class="preview-summary">
                <h3>Summary</h3>
                <p>{{ viz.summary }}</p>
              </section>

              <section *ngIf="viz.callouts?.length" class="preview-callouts">
                <h3>Callouts</h3>
                <ul>
                  <li *ngFor="let item of viz.callouts">{{ item }}</li>
                </ul>
              </section>
            </div>
          </article>
        </div>
      </section>
    </section>
  </ng-container>

<ng-template #noFeatures>
  <p class="empty-hint">No features captured yet.</p>
</ng-template>

<ng-template #noStories>
  <p class="empty-hint">Generate or approve stories to see them here.</p>
</ng-template>

<ng-template #emptyWorkspace>
  <div class="workspace__empty">
    <h2>No items yet</h2>
    <p>Add features, upload project assets, or generate stories to populate the workspace.</p>
    <button type="button" class="workspace__action workspace__action--primary" (click)="onCreateProject()">New Project</button>
  </div>
</ng-template>

